parameters:
  terraformVersion: ''
  workingDirectory: ''
  serviceConnection: ''
  backendResourceGroup: ''
  backendStorageAccount: ''
  backendContainer: ''
  backendKey: ''

steps:
- task: TerraformInstaller@0
  inputs:
    terraformVersion: ${{ parameters.terraformVersion }}

- script: |
    rm -rf .terraform
    rm -f .terraform.lock.hcl
  displayName: 'Clean Terraform Cache'
  workingDirectory: ${{ parameters.workingDirectory }}

- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: azurerm
    command: init
    workingDirectory: ${{ parameters.workingDirectory }}
    backendServiceArm: ${{ parameters.serviceConnection }}
    backendAzureRmResourceGroupName: ${{ parameters.backendResourceGroup }}
    backendAzureRmStorageAccountName: ${{ parameters.backendStorageAccount }}
    backendAzureRmContainerName: ${{ parameters.backendContainer }}
    backendAzureRmKey: ${{ parameters.backendKey }}
    commandOptions: '-reconfigure'
